generator client {
  provider = "prisma-client-js"
}

datasource db {
  provider = "postgresql"
  url      = env("DATABASE_URL")
}

enum UserRole {
  ADMIN
  MANAGER
  TECHNICIAN
  USER
}

enum MaintenanceRequestType {
  CORRECTIVE
  PREVENTIVE
}

enum MaintenanceRequestStatus {
  NEW
  IN_PROGRESS
  REPAIRED
  SCRAP
}

model User {
  id        Int      @id @default(autoincrement())
  name      String
  email     String?  @unique
  avatarUrl String?

  passwordHash String
  role         UserRole @default(USER)

  employee Employee? @relation("EmployeeUser")

  teamMemberships TeamMember[]
  defaultForEquipment Equipment[] @relation("EquipmentDefaultTechnician")
  requestsAssigned MaintenanceRequest[] @relation("RequestTechnician")
  requestsCreated  MaintenanceRequest[] @relation("RequestCreator")

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MaintenanceTeam {
  id        Int      @id @default(autoincrement())
  name      String   @unique

  members   TeamMember[]
  equipment Equipment[]
  requests  MaintenanceRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model TeamMember {
  teamId Int
  userId Int

  team MaintenanceTeam @relation(fields: [teamId], references: [id], onDelete: Cascade)
  user User            @relation(fields: [userId], references: [id], onDelete: Cascade)

  createdAt DateTime @default(now())

  @@id([teamId, userId])
  @@index([userId])
}

model Department {
  id   Int    @id @default(autoincrement())
  name String @unique

  equipment Equipment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Employee {
  id    Int     @id @default(autoincrement())
  name  String
  email String? @unique

  userId Int? @unique
  user   User? @relation("EmployeeUser", fields: [userId], references: [id], onDelete: SetNull)

  equipment Equipment[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model Equipment {
  id                Int      @id @default(autoincrement())
  name              String
  serialNumber      String?  @unique
  category          String?
  purchaseDate      DateTime?
  warrantyInfo      String?
  warrantyExpiresAt DateTime?
  location          String?

  departmentId Int?
  department   Department? @relation(fields: [departmentId], references: [id], onDelete: SetNull)

  employeeId Int?
  employee   Employee? @relation(fields: [employeeId], references: [id], onDelete: SetNull)

  maintenanceTeamId  Int?
  maintenanceTeam    MaintenanceTeam? @relation(fields: [maintenanceTeamId], references: [id], onDelete: SetNull)

  defaultTechnicianId Int?
  defaultTechnician   User? @relation("EquipmentDefaultTechnician", fields: [defaultTechnicianId], references: [id], onDelete: SetNull)

  isUsable Boolean @default(true)

  isArchived Boolean @default(false)
  archivedAt DateTime?

  requests MaintenanceRequest[]

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt
}

model MaintenanceRequest {
  id          Int                     @id @default(autoincrement())
  type        MaintenanceRequestType
  subject     String

  equipmentId Int
  equipment   Equipment               @relation(fields: [equipmentId], references: [id], onDelete: Cascade)

  equipmentCategory String?

  teamId     Int
  team       MaintenanceTeam          @relation(fields: [teamId], references: [id], onDelete: Restrict)

  technicianId Int?
  technician   User?                  @relation("RequestTechnician", fields: [technicianId], references: [id], onDelete: SetNull)

  scheduledDate DateTime?
  durationHours Float?

  status MaintenanceRequestStatus @default(NEW)

  isOverdue Boolean @default(false)

  createdByUserId Int?
  createdByUser   User? @relation("RequestCreator", fields: [createdByUserId], references: [id], onDelete: SetNull)

  createdAt DateTime @default(now())
  updatedAt DateTime @updatedAt

  @@index([teamId])
  @@index([equipmentId])
  @@index([technicianId])
  @@index([status])
  @@index([type])
  @@index([scheduledDate])
}
